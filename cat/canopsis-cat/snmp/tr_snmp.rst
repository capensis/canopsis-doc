.. _TR__snmp:

====
Snmp
====

This guide gives information about how to setup the snmp system within canopsis.

.. contents::
   :depth: 3

----------
References
----------

- :ref:`FR::Snmp functional requirements <fr_snmp>`
- :ref:`ED::Snmp exploitation document <ed_snmp>`

-------
Updates
-------

.. csv-table::
   :header: "Author(s)", "Date", "Version", "Summary", "Accepted by"

   "Eric Régnier", "2015/11/23", "0.1", "Document uses template", ""

--------
Contents
--------


SNMP Engine Admin
=================

`Canopsis Administration Tools` comes with an engine designed to translate SNMP Traps generated by  `snmp2canopsis connector <https://git.canopsis.net/cat/connector-snmp2canopsis>`_

In order to use that engine, you **NEED** to setup snmp2canopsis connector the right way.


Setup
-----
As the SNMP Engine is a Canopsis engine, it requires some configuration in Canopsis.

For debian installation it is necessary to add `contrib` and `non-free` repositories to your `/etc/apt/sources.list` files in order to allow the build install process to properly install smitools package

Supervisord configuration
^^^^^^^^^^^^^^^^^^^^^^^^^

First, you need to declare it in `supervisord` daemons.

Ensure that etc/engines/snmp.ini exists with

.. code-block:: bash
    
    [program:engine-snmp]
    
    autostart=false
    
    directory=%(ENV_HOME)s
    numprocs=1
    process_name=%(program_name)s-%(process_num)d
    
    command=engine-launcher -e snmp -n snmp -w %(process_num)d -l info

Then, add snmp engine in `etc/supervisord.d/amqp2engines.conf`

.. code-block:: bash

    [group:amqp2engines]
    
    autostart=false
    
    programs=engine-cleaner-events,engine-event-filter,engine-downtime,engine-acknowledgement,engine-cancel,engine-ticket,engine-tag,engine-eventstore,engine-cleaner-alerts,engine-selector,engine-collectdgw,engine-crecord-dispatcher,engine-scheduler,taskhandler-mail,engine-perfdata,engine-context,engine-stats,engine-topology,engine-linklist, **engine-snmp,** taskhandler-linklist,taskhandler-dataclean


RabbitMQ Vhost
^^^^^^^^^^^^^^

Next, you have to setup configure the snmp engine rabbitmq vhost

Edit `etc/amqp2engines.conf` and add at the beginning of the file :

.. code-block:: bash

    # SNMP
    
    [engine:snmp]
    
    routing_keys=#
    exchange_name=canopsis.snmp


.. note::

   Don't forget that `exchange name` must be the same with `snmp2canopsis connector <https://git.canopsis.net/cat/connector-snmp2canopsis>`_ 's conf


Starting engines
^^^^^^^^^^^^^^^^

To finish the setup, you just need to (re)start ̀ amqp2engines` service 

.. code-block:: bash

    $ service amqp2engines restart


You can see if snmp engine is started 

.. code-block:: bash

    $ service amqp2engines status

    ...
    amqp2engines:engine-snmp-0 RUNNING    pid 18632, uptime 3:07:28
    ...


Troubleshooting
---------------

First of all, you must be aware of the trap event cycle

.. code-block:: bash

    SNMP equipment : send snmp traps (UDP 162)
	||
	||
    snmp2canopsis connector : listen to traps and build messages to AMQP destination (OID are not translated)
	||
	||
    RabbitMQ SNMP Exchange : wait for messages from snmp2canopsis connector
	||
	||
    SNMP engine : try to build event with event_type=check thanks to SNMP rules
	||
	||
    RabbitMQ Events Exchange : This is Canopsis !


